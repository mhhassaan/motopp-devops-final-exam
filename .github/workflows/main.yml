name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f motopp/requirements.txt ]; then pip install -r motopp/requirements.txt; fi
          pip install flake8 pytest

      - name: Lint with Flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings.
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  build-and-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./motopp
          push: true
          # START: Update this to match your Docker Hub Username
          tags: ${{ secrets.DOCKER_USERNAME }}/motopp:latest
          # END

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 1. Update Code
            cd motopp-final-exam
            git pull origin main

            # 2. Check Minikube and refresh IP context
            if ! minikube status | grep -q "Running"; then
              echo "‚ö†Ô∏è Minikube is down! Restarting..."
              minikube start --driver=docker
            else
              echo "‚úÖ Minikube is running. Refreshing context..."
              minikube update-context
            fi

            # 3. Create Namespace & Apply
            if ! kubectl get namespace prod > /dev/null 2>&1; then
              kubectl create namespace prod
            fi
            echo "üöÄ Applying configurations..."
            kubectl apply -f motopp/k8s -n prod

            # 4. Restart Deployment & Wait
            kubectl rollout restart deployment/motopp -n prod
            kubectl rollout status deployment/motopp -n prod

            # ====================================================
            # 5. INTEGRATED SMOKE TEST
            # ====================================================
            echo "üß™ Starting Smoke Test..."

            # Start port-forward in the background just for this session
            # We don't need 'nohup' because we will kill it ourselves when done
            kubectl port-forward --address 0.0.0.0 service/motopp 30001:30001 -n prod > /dev/null 2>&1 &
            PF_PID=$! # Capture the Process ID so we can kill it later

            # Give it 5 seconds to initialize
            sleep 5

            # Run the curl test locally on the server
            # If this fails, the whole deploy job will fail (which is what you want)
            echo "Testing endpoint..."
            if curl --fail --retry 3 --retry-delay 2 http://localhost:30001; then
              echo ""
              echo "‚úÖ Smoke Test Passed: App is reachable!"
              kill $PF_PID # Clean up
              exit 0
            else
              echo ""
              echo "‚ùå Smoke Test Failed: App is unreachable."
              kill $PF_PID # Clean up
              exit 1
            fi



        # # 1. Update Code
        # cd motopp-final-exam
        # git pull origin main

        # # 2. Check Minikube and refresh IP context
        # if ! minikube status | grep -q "Running"; then
        #   echo "‚ö†Ô∏è Minikube is down! Restarting..."
        #   minikube start --driver=docker
        # else
        #   echo "‚úÖ Minikube is running. Refreshing context..."
        #   minikube update-context
        # fi

        # # 3. Create Namespace (if it doesn't exist)
        # # We check first to avoid an error if it already exists
        # if ! kubectl get namespace prod > /dev/null 2>&1; then
        #   echo "‚ö†Ô∏è Namespace 'prod' missing. Creating it..."
        #   kubectl create namespace prod
        # fi

        # # 4. Apply Kubernetes Manifests
        # # This creates or updates the deployment/service from your yaml files
        # echo "üöÄ Applying configurations from motopp/k8s..."
        # kubectl apply -f motopp/k8s -n prod

        # # 5. Restart Deployment
        # # This forces the pods to restart (useful if the image tag is 'latest')
        # kubectl rollout restart deployment/motopp -n prod
        # kubectl rollout status deployment/motopp -n prod
      # - name: Post-Deploy Smoke Test
      #   run: |
      #     # Simple check to see if the server responds
      #     curl -f http://${{ secrets.SSH_HOST }}:30001 || echo "Warning: Server did not respond"



      