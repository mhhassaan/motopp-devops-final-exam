name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f motopp/requirements.txt ]; then pip install -r motopp/requirements.txt; fi
          pip install flake8 pytest

      - name: Lint with Flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings.
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  build-and-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./motopp
          push: true
          # START: Update this to match your Docker Hub Username
          tags: ${{ secrets.DOCKER_USERNAME }}/motopp:latest
          # END

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 1. Update Code
            cd motopp-final-exam
            git pull origin main

            # 2. DESPERATE SYSTEM CLEANUP
            echo "üßπ Starting deep system cleanup..."

            # Clean systemd logs (often frees 500MB+)
            sudo journalctl --vacuum-time=1s

            # Clean Apt cache
            sudo apt-get clean
            sudo rm -rf /var/lib/apt/lists/*

            # Clean Snap cache (often frees 1GB+ on Ubuntu)
            sudo rm -rf /var/lib/snapd/cache/*

            # Clean generic temp files
            sudo rm -rf /tmp/*

            # Drop RAM caches to free up memory
            sudo sysctl -w vm.drop_caches=3

            # Show space status
            echo "üíæ Disk usage after deep clean:"
            df -h /

            # 3. FRESH START (Conservative Mode)
            echo "üß® Deleting old Minikube cluster..."
            minikube delete --all

            echo "üöÄ Starting fresh Minikube..."
            # Reduced memory to 1900mb to prevent crashing the OS
            # Added --wait=all to ensure stability before proceeding
            minikube start --driver=docker --disk-size=20g --memory=1900mb --force --wait=all

            # 4. Setup Namespace & Deploy
            echo "üõ†Ô∏è Creating Namespace..."
            kubectl create namespace prod

            echo "üöÄ Applying configurations..."
            kubectl apply -f motopp/k8s -n prod

            # 5. Wait for Rollout
            echo "‚è≥ Waiting for deployment to be ready..."
            if ! kubectl rollout status deployment/motopp -n prod --timeout=120s; then
              echo "‚ùå Deployment failed."
              kubectl get pods -n prod
              kubectl logs -l app=motopp -n prod --all-containers
              exit 1
            fi
      - name: Post-Deploy Smoke Test
        run: |
          # Simple check to see if the server responds
          curl -f http://${{ secrets.SSH_HOST }}:30001 || echo "Warning: Server did not respond"



      