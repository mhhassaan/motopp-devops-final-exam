name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f motopp/requirements.txt ]; then pip install -r motopp/requirements.txt; fi
          pip install flake8 pytest

      - name: Lint with Flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  build-and-push:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./motopp
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/motopp:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to AWS EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "===== DISK USAGE (BEFORE) ====="
            df -h

            echo "ðŸ§¹ Cleaning Docker & Minikube..."
            docker container prune -f
            docker image prune -af
            docker volume prune -f
            docker network prune -f

            minikube delete || true
            minikube start --driver=docker --memory=2048

            echo "===== DISK USAGE (AFTER) ====="
            df -h

            echo "ðŸ“¦ Ensuring prod namespace exists..."
            minikube kubectl -- create namespace prod --dry-run=client -o yaml | \
            minikube kubectl -- apply -f -

            echo "ðŸš€ Deploying application..."
            cd motopp-final-exam
            git pull origin main
            echo "ðŸ“¦ Applying Kubernetes manifests..."
            cd ./motopp
            minikube kubectl -- apply -n prod -f k8s/

            minikube kubectl -- rollout restart deployment/motopp -n prod
            minikube kubectl -- rollout status deployment/motopp -n prod

      - name: Post-Deploy Smoke Test
        run: |
          curl -f http://${{ secrets.SSH_HOST }}:30001 || echo "Warning: App might be starting up"
